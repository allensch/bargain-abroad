// Generated by CoffeeScript 1.6.2
(function() {
  App.LoginController = Ember.ObjectController.extend({
    needs: ['auth', 'index'],
    error: false,
    loading: false,
    username: null,
    password: null,
    pendingTransition: null,
    loginBeforePurchase: false,
    reset: function() {
      this.setFlags(false, false);
      this.setProperties({
        username: null,
        password: null,
        loginBeforePurchase: this.get('controllers.index.canGoToConfirm')
      });
    },
    setFlags: function(error, loading) {
      this.set('error', error);
      this.set('loading', loading);
    },
    onAuthUser: (function() {
      if (this.get('controllers.auth.user')) {
        this.doTransition();
      }
    }).observes('controllers.auth.user'),
    doTransition: function() {
      var transition;

      transition = this.get('pendingTransition');
      if (transition) {
        this.set('pendingTransition', null);
        transition.retry();
      } else {
        this.transitionToRoute('index');
      }
    },
    actions: {
      login: function() {
        var data,
          _this = this;

        this.setFlags(false, true);
        data = this.getProperties('username', 'password');
        Ember.$.post('rest/user/login', data).then(function(response) {
          _this.get('controllers.auth').authenticate(response);
        }, function(error) {
          console.error('LOGIN', error);
          _this.setFlags(true, false);
        });
      }
    }
  });

}).call(this);
